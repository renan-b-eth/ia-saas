{% extends "base.html" %}

{% block content %}
<script src="https://unpkg.com/@lucide/web-bin"></script>

{# -----------------------------
   Helpers / fallbacks
------------------------------ #}
{% set access_fn = access if access is defined else none %}
{% set recs = recomendações if recomendações is defined else (recomendacoes if recomendacoes is defined else []) %}

<div class="pt-24 pb-16">
  <div class="max-w-7xl mx-auto px-6">

    <!-- Header / Hero -->
    <section class="relative overflow-hidden rounded-[2.75rem] border border-white/5 bg-gradient-to-br from-white/5 to-white/[0.02] shadow-2xl">
      <div class="absolute inset-0 pointer-events-none">
        <div class="absolute -top-32 -right-40 w-[38rem] h-[38rem] rounded-full bg-blue-500/10 blur-3xl"></div>
        <div class="absolute -bottom-40 -left-40 w-[34rem] h-[34rem] rounded-full bg-purple-500/10 blur-3xl"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_1px_1px,rgba(255,255,255,.06)_1px,transparent_0)] [background-size:24px_24px] opacity-30"></div>
      </div>

      <div class="relative p-8 md:p-10">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8">
          <div class="flex items-center gap-5">
            <div class="relative">
              <img
                src="{{ user.avatar_url }}"
                class="w-20 h-20 rounded-[2rem] border border-white/10 object-cover shadow-xl"
                onerror="this.src='https://ui-avatars.com/api/?name={{ (user.company_name or 'R')|urlencode }}&background=0b1220&color=fff&bold=true'"
                alt="Avatar"
              />
              <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-emerald-500 border-4 border-black rounded-full shadow"></div>
            </div>

            <div>
              <div class="flex flex-wrap items-center gap-2">
                <h1 class="text-3xl md:text-4xl font-black tracking-tight leading-none">
                  {{ user.company_name or (user.full_name or "Sua conta") }}
                </h1>
                <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs font-bold uppercase tracking-widest text-white/80">
                  <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span>
                  {{ (effective_plan or user.plan_tier or 'free')|upper }}
                </span>
              </div>

              <div class="mt-2 flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-white/60">
                <div class="inline-flex items-center gap-2">
                  <i data-lucide="calendar" class="w-4 h-4"></i>
                  <span id="current-date">—</span>
                </div>
                <div class="inline-flex items-center gap-2">
                  <i data-lucide="map-pin" class="w-4 h-4"></i>
                  <span>Rendey Cloud • Boise, ID</span>
                </div>
                <div class="inline-flex items-center gap-2">
                  <i data-lucide="shield-check" class="w-4 h-4"></i>
                  <span>Ambiente seguro (rate-limit & guardrails)</span>
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
            <a href="/profile" class="group inline-flex items-center justify-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-5 py-3 font-bold text-sm hover:bg-white/10 transition">
              <i data-lucide="settings" class="w-4 h-4"></i>
              Configurações
              <i data-lucide="chevron-right" class="w-4 h-4 opacity-60 group-hover:translate-x-0.5 transition"></i>
            </a>
            <a href="/pricing" class="group inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-5 py-3 font-black text-sm shadow-xl shadow-blue-600/20 hover:brightness-110 transition">
              <i data-lucide="sparkles" class="w-4 h-4"></i>
              Upgrade
              <span class="opacity-80">•</span>
              destravar tudo
            </a>
          </div>
        </div>

        {% if effective_plan == 'pro' and user.plan_tier == 'free' %}
        <div class="mt-8 rounded-[2rem] border border-blue-500/20 bg-blue-500/10 p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-start gap-3">
            <div class="mt-0.5 inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-blue-500/20 border border-blue-500/20">
              <i data-lucide="zap" class="w-5 h-5 text-blue-300"></i>
            </div>
            <div>
              <p class="font-black text-lg">Teste Pro ativo</p>
              <p class="text-white/70 text-sm">
                Restam <span class="font-extrabold text-white">{{ days_left }}</span> dias para aproveitar todos os agentes sem limites.
              </p>
            </div>
          </div>
          <a href="/pricing" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-white text-black px-6 py-3 font-black hover:scale-[1.02] transition shadow">
            Garantir acesso
            <i data-lucide="arrow-right" class="w-4 h-4"></i>
          </a>
        </div>
        {% endif %}

        <!-- KPI cards -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="rounded-[2rem] border border-white/10 bg-black/30 p-6">
            <div class="flex items-center justify-between">
              <p class="text-xs font-bold uppercase tracking-widest text-white/50">Plano atual</p>
              <i data-lucide="badge-check" class="w-5 h-5 text-emerald-400"></i>
            </div>
            <p class="mt-2 text-2xl font-black">{{ (effective_plan or user.plan_tier or 'free')|upper }}</p>
            <p class="mt-1 text-sm text-white/60">
              {% if effective_plan == 'free' %}Ideal para testar. Recomendo Pro para destravar automações.{% else %}Tudo pronto para escalar com agentes e relatórios.{% endif %}
            </p>
          </div>

          <div class="rounded-[2rem] border border-white/10 bg-black/30 p-6">
            <div class="flex items-center justify-between">
              <p class="text-xs font-bold uppercase tracking-widest text-white/50">Status da assinatura</p>
              <i data-lucide="timer" class="w-5 h-5 text-blue-400"></i>
            </div>
            <p class="mt-2 text-2xl font-black">
              {% if days_left is defined and days_left is not none %}
                {{ days_left }} dias
              {% else %}
                Ativa
              {% endif %}
            </p>
            <p class="mt-1 text-sm text-white/60">
              {% if days_left is defined and days_left is not none %}
                Renove antes de expirar para não perder acesso.
              {% else %}
                Cobrança e upgrades disponíveis em <a href="/pricing" class="text-blue-300 hover:underline font-bold">/pricing</a>.
              {% endif %}
            </p>
          </div>

          <div class="rounded-[2rem] border border-white/10 bg-black/30 p-6">
            <div class="flex items-center justify-between">
              <p class="text-xs font-bold uppercase tracking-widest text-white/50">Atalhos</p>
              <i data-lucide="rocket" class="w-5 h-5 text-purple-400"></i>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">
              <a href="/tool/instavideo" class="inline-flex items-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-bold hover:bg-white/10 transition">
                <i data-lucide="clapperboard" class="w-4 h-4"></i> Reels
              </a>
              <a href="/tool/spy" class="inline-flex items-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-bold hover:bg-white/10 transition">
                <i data-lucide="radar" class="w-4 h-4"></i> Concorrência
              </a>
              <a href="/knowledge" class="inline-flex items-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-bold hover:bg-white/10 transition">
                <i data-lucide="brain" class="w-4 h-4"></i> Memória
              </a>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Recommended -->
    <section class="mt-12">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-2xl bg-blue-600/20 border border-blue-500/20 flex items-center justify-center">
            <i data-lucide="sparkles" class="w-5 h-5 text-blue-300"></i>
          </div>
          <div>
            <h2 class="text-lg md:text-xl font-black tracking-tight">Recomendado para {{ user.company_name }}</h2>
            <p class="text-sm text-white/60">Atalhos inteligentes para ganhar resultado rápido.</p>
          </div>
        </div>

        <a href="/support" class="hidden md:inline-flex items-center gap-2 text-sm font-bold text-white/70 hover:text-white transition">
          Ver guia de uso <i data-lucide="arrow-right" class="w-4 h-4"></i>
        </a>
      </div>

      <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        {% for tool_id in recs %}
          {% set tool = tools.get(tool_id) if tools is defined else none %}
          {% if tool %}
          <a href="/tool/{{ tool_id }}" class="group relative overflow-hidden rounded-[2.25rem] border border-white/10 bg-gradient-to-br from-white/5 to-black/40 p-6 hover:border-blue-500/30 transition shadow-xl">
            <div class="absolute -top-16 -right-16 w-40 h-40 rounded-full bg-blue-500/10 blur-2xl group-hover:bg-blue-500/20 transition"></div>
            <div class="relative">
              <div class="flex items-center justify-between">
                <div class="text-4xl">{{ tool.icon }}</div>
                <i data-lucide="star" class="w-5 h-5 text-blue-400 opacity-70"></i>
              </div>
              <h3 class="mt-4 text-lg font-black group-hover:text-blue-300 transition">{{ tool.name }}</h3>
              <p class="mt-2 text-sm text-white/60">Agente focado em impacto imediato com linguagem simples e direta.</p>
              <div class="mt-5 inline-flex items-center gap-2 text-xs font-black uppercase tracking-widest text-blue-300">
                Acessar <i data-lucide="chevron-right" class="w-4 h-4"></i>
              </div>
            </div>
          </a>
          {% endif %}
        {% endfor %}
      </div>
    </section>

    <!-- All agents -->
    <section class="mt-12">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
        <div>
          <h2 class="text-xl md:text-2xl font-black tracking-tight">Agentes</h2>
          <p class="text-sm text-white/60">Busque, filtre e execute em segundos.</p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
          <div class="relative">
            <i data-lucide="search" class="w-4 h-4 text-white/40 absolute left-4 top-1/2 -translate-y-1/2"></i>
            <input id="tool-search" type="text" placeholder="Buscar agente..." class="w-full sm:w-80 rounded-2xl bg-white/5 border border-white/10 pl-11 pr-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:ring-2 focus:ring-blue-500/40" />
          </div>

          <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
            <button onclick="filterTools('all')" class="cat-btn active px-4 py-2 rounded-xl text-xs font-black transition">Todos</button>
            <button onclick="filterTools('Marketing')" class="cat-btn px-4 py-2 rounded-xl text-xs font-black transition">Marketing</button>
            <button onclick="filterTools('Operacional')" class="cat-btn px-4 py-2 rounded-xl text-xs font-black transition">Operação</button>
            <button onclick="filterTools('Estratégico')" class="cat-btn px-4 py-2 rounded-xl text-xs font-black transition">Estratégia</button>
            <button onclick="filterTools('RH')" class="cat-btn px-4 py-2 rounded-xl text-xs font-black transition">RH</button>
          </div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4" id="tools-grid">
        {% for key, tool in tools.items() %}
          {% set locked = false %}
          {% if access_fn is not none %}
            {% set locked = not access_fn(user, tool.min_plan) %}
          {% endif %}

          {% set cat = "Marketing" %}
          {% if key in ['sop', 'waste', 'delivery', 'loss_prevention'] %}{% set cat = "Operacional" %}{% endif %}
          {% if key in ['persona', 'spy', 'audit', 'menu_eng', 'shark_negotiator'] %}{% set cat = "Estratégico" %}{% endif %}
          {% if key in ['job_desc', 'interview'] %}{% set cat = "RH" %}{% endif %}

          <div class="tool-card" data-category="{{ cat }}" data-name="{{ (tool.name or key)|lower }}">
            {% if locked %}
              <a href="/pricing" class="group relative block h-full overflow-hidden rounded-3xl border border-white/10 bg-white/5 p-5 opacity-75 hover:opacity-100 transition">
                <div class="absolute inset-0 bg-gradient-to-b from-black/0 to-black/60"></div>
                <div class="relative z-10 flex flex-col items-center text-center">
                  <div class="text-4xl mb-4 grayscale">{{ tool.icon }}</div>
                  <h3 class="font-black text-white/70 text-sm">{{ tool.name }}</h3>
                  <p class="mt-2 text-[11px] text-white/40">Bloqueado • Upgrade para liberar</p>
                  <div class="mt-4 inline-flex items-center gap-2 rounded-2xl bg-white text-black px-4 py-2 text-xs font-black">
                    <i data-lucide="lock" class="w-4 h-4"></i> Desbloquear
                  </div>
                </div>
              </a>
            {% else %}
              <a href="/tool/{{ key }}" class="group block h-full rounded-3xl border border-white/10 bg-gradient-to-b from-white/5 to-black/40 p-5 hover:border-blue-500/30 hover:bg-white/10 transition shadow-xl">
                <div class="flex items-center justify-between">
                  <div class="text-4xl">{{ tool.icon }}</div>
                  <i data-lucide="arrow-up-right" class="w-5 h-5 text-white/40 group-hover:text-blue-300 transition"></i>
                </div>
                <h3 class="mt-4 font-black text-white text-sm group-hover:text-blue-200 transition">{{ tool.name }}</h3>
                <p class="mt-2 text-[11px] text-white/50 line-clamp-2">Executa com um clique e salva resultado no histórico.</p>
                <div class="mt-4 text-[10px] font-black uppercase tracking-widest text-blue-300 opacity-0 group-hover:opacity-100 transition">
                  Abrir agente
                </div>
              </a>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </section>

    <!-- Bottom: Help + History -->
    <section class="mt-12 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1 space-y-6">
        <div class="rounded-[2.5rem] border border-white/10 bg-gradient-to-br from-blue-600/20 to-purple-600/10 p-8 overflow-hidden relative">
          <div class="absolute -bottom-16 -right-16 w-56 h-56 rounded-full bg-blue-500/10 blur-2xl"></div>
          <div class="relative">
            <h3 class="text-2xl font-black leading-tight">Venda mais com um agente personalizado</h3>
            <p class="mt-3 text-white/70 text-sm">Criamos fluxos exclusivos para o seu processo (menu, estoque, marketing e treinamento).</p>
            <a href="mailto:contact@rendey.store" class="mt-6 inline-flex items-center justify-center gap-2 rounded-2xl bg-white text-black px-6 py-3 font-black hover:scale-[1.02] transition">
              Falar com engenharia <i data-lucide="mail" class="w-4 h-4"></i>
            </a>
          </div>
        </div>

        <div class="rounded-[2.5rem] border border-white/10 bg-white/5 p-8">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-2xl bg-emerald-500/15 border border-emerald-500/20 flex items-center justify-center">
              <i data-lucide="help-circle" class="w-5 h-5 text-emerald-300"></i>
            </div>
            <div>
              <h3 class="text-lg font-black">Centro de Ajuda</h3>
              <p class="text-sm text-white/60">Guia rápido, melhores práticas e exemplos prontos.</p>
            </div>
          </div>
          <a href="/support" class="mt-6 inline-flex items-center gap-2 text-sm font-black text-blue-300 hover:text-blue-200 transition">
            Acessar guia <i data-lucide="arrow-right" class="w-4 h-4"></i>
          </a>
        </div>
      </div>

      <div class="lg:col-span-2 rounded-[2.5rem] border border-white/10 bg-white/5 overflow-hidden shadow-2xl">
        <div class="p-8 border-b border-white/10 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center">
              <i data-lucide="clock" class="w-5 h-5 text-white/60"></i>
            </div>
            <div>
              <h2 class="text-lg font-black">Histórico recente</h2>
              <p class="text-sm text-white/60">Últimos 20 resultados gerados.</p>
            </div>
          </div>
          <span class="text-xs text-white/40 font-black uppercase tracking-widest">Auto-salvo</span>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-black/30 text-white/40 text-[10px] uppercase font-black tracking-widest">
              <tr>
                <th class="px-8 py-4">Agente</th>
                <th class="px-8 py-4">Execução</th>
                <th class="px-8 py-4">Status</th>
                <th class="px-8 py-4 text-right">Resultado</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-white/10">
              {% for report in reports %}
              <tr class="hover:bg-white/5 transition">
                <td class="px-8 py-5">
                  <div class="flex items-center gap-3">
                    <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                    <span class="font-bold">{{ report.tool_name }}</span>
                  </div>
                </td>
                <td class="px-8 py-5 text-white/60 text-sm">
                  {{ report.date_created.strftime('%d %b, %H:%M') if report.date_created else '-' }}
                </td>
                <td class="px-8 py-5">
                  {% if report.status == 'COMPLETED' %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-emerald-500/10 border border-emerald-500/20 px-3 py-1 text-xs font-black text-emerald-300">
                      <i data-lucide="check-circle" class="w-4 h-4"></i> Pronto
                    </span>
                  {% elif report.status and 'PROCESSING' in report.status %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-yellow-500/10 border border-yellow-500/20 px-3 py-1 text-xs font-black text-yellow-300">
                      <i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Processando
                    </span>
                  {% else %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-red-500/10 border border-red-500/20 px-3 py-1 text-xs font-black text-red-300">
                      <i data-lucide="alert-circle" class="w-4 h-4"></i> Falha
                    </span>
                  {% endif %}
                </td>
                <td class="px-8 py-5 text-right">
                  <a href="/report/{{ report.id }}" class="inline-flex items-center gap-2 rounded-xl bg-white/5 border border-white/10 px-4 py-2 text-xs font-black text-white/70 hover:bg-blue-600 hover:border-blue-500 hover:text-white transition">
                    Abrir <i data-lucide="arrow-right" class="w-4 h-4"></i>
                  </a>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" class="px-8 py-16 text-center text-white/40 font-black uppercase tracking-widest">
                  Nenhuma atividade registrada
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </div>
</div>

<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

  .cat-btn { background: rgba(255,255,255,.04); color: rgba(255,255,255,.65); border: 1px solid rgba(255,255,255,.08); }
  .cat-btn:hover { background: rgba(255,255,255,.07); color: white; }
  .cat-btn.active { background: rgba(37, 99, 235, .9); color: white; border-color: rgba(37, 99, 235, .5); box-shadow: 0 18px 30px -18px rgba(37, 99, 235, .7); }

  .tool-card.hidden { display: none; }
</style>

<script>
  lucide.createIcons();

  // Date (pt-BR)
  (function () {
    const el = document.getElementById('current-date');
    if (!el) return;
    const now = new Date();
    try {
      el.textContent = now.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'short', year: 'numeric' });
    } catch (e) {
      el.textContent = now.toDateString();
    }
  })();

  // Category filter + search
  let activeCategory = 'all';

  function filterTools(category) {
    activeCategory = category;
    document.querySelectorAll('.cat-btn').forEach(btn => {
      btn.classList.remove('active');
      const txt = (btn.innerText || '').toLowerCase();
      if ((category === 'all' && txt === 'todos') || txt === category.toLowerCase()) btn.classList.add('active');
    });
    applyFilters();
  }

  function applyFilters() {
    const q = (document.getElementById('tool-search')?.value || '').trim().toLowerCase();
    document.querySelectorAll('.tool-card').forEach(card => {
      const cardCat = card.getAttribute('data-category');
      const name = card.getAttribute('data-name') || '';
      const okCat = (activeCategory === 'all') || (cardCat === activeCategory);
      const okQ = (!q) || name.includes(q);
      card.classList.toggle('hidden', !(okCat && okQ));
    });
  }

  document.getElementById('tool-search')?.addEventListener('input', applyFilters);
</script>
{% endblock %}
